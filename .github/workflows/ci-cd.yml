name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

env:
  NODE_VERSION: '18'
  PROJECT_NAME: 'weather-dashboard'

jobs:
  # JOB 1: Code Quality Checks
  lint-and-test:
    name: "Lint & Test"
    runs-on: ubuntu-latest
    
    steps:
    - name: "Checkout code"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: "Setup Node.js"
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: "Install dependencies"
      run: npm ci
    
    - name: "List project structure"
      run: |
        echo "Project Structure:"
        ls -la
        echo ""
        echo "HTML files:"
        ls *.html || true
    
    - name: "Run tests"
      run: npm test
      continue-on-error: true  # Continue even if tests fail for learning
    
    - name: "Lint code"
      run: npm run lint
      continue-on-error: true
    
    - name: "Validate HTML"
      run: npx html-validate *.html
      continue-on-error: true
    
    - name: "Test Report"
      if: always()
      run: |
        echo "=== Test Summary ==="
        echo "✓ Lint and test steps completed"
        echo "✓ This is a learning project - we're focusing on CI/CD setup"
        echo "=== End Report ==="

  # JOB 2: Build and Package
  build:
    name: "Build"
    runs-on: ubuntu-latest
    needs: lint-and-test  # Depends on previous job
    if: github.event_name == 'push'  # Only build on push
    
    steps:
    - name: "Checkout code"
      uses: actions/checkout@v4
    
    - name: "Setup Node.js"
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: "Install dependencies"
      run: npm ci
    
    - name: "Build project"
      run: npm run build
    
    - name: "Create build artifact"
      run: |
        mkdir -p dist
        cp -r *.html *.css *.js dist/
        echo "Build completed at $(date)" > dist/build-info.txt
        echo "Commit: ${{ github.sha }}" >> dist/build-info.txt
    
    - name: "Upload build artifact"
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.PROJECT_NAME }}-build
        path: dist/
    
    - name: "Build Report"
      run: |
        echo "=== Build Summary ==="
        echo "Build completed successfully"
        echo "Artifact created: ${{ env.PROJECT_NAME }}-build"
        echo "SHA: ${{ github.sha }}"
        echo "=== End Report ==="

  # JOB 3: Deploy to GitHub Pages
  deploy:
    name: "Deploy"
    runs-on: ubuntu-latest
    needs: build  # Depends on build job
    if: github.ref == 'refs/heads/main'  # Only deploy from main branch
    
    permissions:
      contents: write  # Needed to push to gh-pages
    
    steps:
    - name: "Download build artifact"
      uses: actions/download-artifact@v3
      with:
        name: ${{ env.PROJECT_NAME }}-build
    
    - name: "List deployment files"
      run: |
        echo "Files to deploy:"
        find . -type f | sort
    
    - name: "Deploy to GitHub Pages"
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: "Deploy: ${{ github.event.head_commit.message || 'Auto deploy' }}"
    
    - name: "Deployment Report"
      run: |
        echo "=== Deployment Summary ==="
        echo "Successfully deployed to GitHub Pages!"
        echo "Your site will be available at:"
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "Deployment time: $(date)"
        echo "=== End Report ==="

  # JOB 4: Send Notification
  notify:
    name: "Notify"
    runs-on: ubuntu-latest
    needs: [lint-and-test, build, deploy]
    if: always()  # Always run, even if previous jobs fail
    
    steps:
    - name: "Generate Status Report"
      run: |
        echo "# CI/CD Pipeline Status" > status-report.md
        echo "" >> status-report.md
        echo "## Workflow: ${{ github.workflow }}" >> status-report.md
        echo "## Repository: ${{ github.repository }}" >> status-report.md
        echo "## Triggered by: ${{ github.actor }}" >> status-report.md
        echo "## Commit: ${{ github.sha }}" >> status-report.md
        echo "" >> status-report.md
        echo "### Job Status:" >> status-report.md
        echo "- Lint & Test: ${{ needs.lint-and-test.result }}" >> status-report.md
        echo "- Build: ${{ needs.build.result }}" >> status-report.md
        echo "- Deploy: ${{ needs.deploy.result }}" >> status-report.md
        echo "" >> status-report.md
        echo "Generated at: $(date)" >> status-report.md
    
    - name: "Upload Status Report"
      uses: actions/upload-artifact@v3
      with:
        name: pipeline-status-report
        path: status-report.md
    
    - name: "Final Message"
      run: |
        echo "================================="
        echo "    CI/CD Pipeline Complete!"
        echo "================================="
        echo ""
        echo "Summary:"
        echo "  Repository: ${{ github.repository }}"
        echo "  Commit: ${GITHUB_SHA:0:8}"
        echo "  Workflow: ${{ github.workflow }}"
        echo ""
        echo "Next steps:"
        echo "  1. Visit your site:"
        echo "     https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "  2. Check workflow runs:"
        echo "     https://github.com/${{ github.repository }}/actions"
        echo "  3. View artifacts for detailed reports"
        echo "================================="